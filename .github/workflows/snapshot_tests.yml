name: Snapshot tests
on:
  pull_request

env:
  # renovate: datasource=github-tags depName=rust lookupName=rust-lang/rust
  RUST_VERSION: 1.88.0

jobs:
  snapshot-tests:
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.body, 'RUN_SNAPSHOT_TESTS')
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
      - run: rustup override set ${{ env.RUST_VERSION }}
      - uses: Swatinem/rust-cache@f13886b937689c021905a6b90929199931d60db1 # v2.8.1
      - name: Install Zola
        run: cargo install --locked --git https://github.com/getzola/zola --rev 45d3f8d6285f0b47013c5fa31eb405332118af8b

      - run: git fetch --depth 2
      - run: git checkout origin/main
      - name: Generate good snapshots
        run: INSTA_OUTPUT=none INSTA_UPDATE=always cargo test -p snapshot -- --include-ignored
      - run: git checkout $GITHUB_SHA # merge of main+branch
      - run: INSTA_OUTPUT=none INSTA_UPDATE=no cargo test -p snapshot -- --include-ignored
